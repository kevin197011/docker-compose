services:
  # JumpServer 一体化服务（包含所有组件）
  jumpserver:
    image: jumpserver/jms_all:latest
    container_name: jumpserver
    restart: always
    privileged: true
    environment:
      # 核心配置
      SECRET_KEY: "t0q_hA1ST8DjbMIBjlU0KtAVAcZP_L7W82wn2Pn_l6k="
      BOOTSTRAP_TOKEN: "dfe57f20b3587954cff40591474bd187"
      DEBUG: "false"
      LOG_LEVEL: "INFO"
      # 数据库配置（使用外部 MySQL）
      DB_ENGINE: "mysql"
      DB_HOST: "mysql"
      DB_PORT: "3306"
      DB_USER: "jumpserver"
      DB_PASSWORD: "ruU1y_bwMiFadh7mbvLawg=="
      DB_NAME: "jumpserver"
      # Redis 配置（使用外部 Redis）
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "6qDCfy1WYMQwzxXhIBflig=="
      # 会话配置
      SESSION_COOKIE_AGE: "86400"
      SESSION_EXPIRE_AT_BROWSER_CLOSE: "true"
      # 网络配置
      BIND_HOST: "0.0.0.0"
      HTTP_PORT: "80"
      SSHD_PORT: "2222"
      ALLOWED_HOSTS: "localhost,127.0.0.1,0.0.0.0,*"
      # Celery 配置
      CELERY_BROKER_URL: "redis://:6qDCfy1WYMQwzxXhIBflig==@redis:6379/3"
      CELERY_RESULT_BACKEND: "redis://:6qDCfy1WYMQwzxXhIBflig==@redis:6379/4"
      CELERY_TASK_SERIALIZER: "json"
      CELERY_RESULT_SERIALIZER: "json"
      CELERY_ACCEPT_CONTENT: "json"
      # 邮件配置
      EMAIL_HOST: "smtp.gmail.com"
      EMAIL_PORT: "587"
      EMAIL_USE_TLS: "true"
      EMAIL_HOST_USER: ""
      EMAIL_HOST_PASSWORD: ""
      EMAIL_SUBJECT_PREFIX: "[JumpServer] "
      EMAIL_BACKEND: "django.core.mail.backends.console.EmailBackend"
      # 安全配置
      SECURITY_PASSWORD_RESET_LIMIT: "5"
      SECURITY_LOGIN_LIMIT_TIME: "30"
      SECURITY_LOGIN_LIMIT_COUNT: "7"
      # 站点配置
      SITE_URL: "http://localhost"
    volumes:
      # 数据持久化
      - ./data/jumpserver:/opt/jumpserver/data
      - ./data/core/media:/opt/jumpserver/data/media
      - ./data/core/static:/opt/jumpserver/data/static
      - ./logs/jumpserver:/opt/jumpserver/logs
      # 如果需要自定义配置
      - ./config/jumpserver:/opt/jumpserver/config
    ports:
      - "80:80" # HTTP 端口
      - "2222:2222" # SSH 端口
      - "30000-30100:30000-30100" # RDP/VNC 端口范围
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - jumpserver_net
  # MySQL 数据库服务
  mysql:
    image: mysql:8.0
    container_name: jumpserver_mysql
    restart: always
    # MySQL 8.0: 移除已弃用的 --default-authentication-plugin 命令行参数
    # 认证插件配置在 my.cnf 文件中设置
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: VNyupGRpS9Ah8vd3F6gpsA==
      MYSQL_DATABASE: jumpserver
      MYSQL_USER: jumpserver
      MYSQL_PASSWORD: ruU1y_bwMiFadh7mbvLawg==
      # 修复时区警告：设置时区
      TZ: UTC
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pVNyupGRpS9Ah8vd3F6gpsA=="]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - jumpserver_net
  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: jumpserver_redis
    restart: always
    command: redis-server --requirepass 6qDCfy1WYMQwzxXhIBflig== --appendonly yes
    volumes:
      - ./data/redis:/data
      - ./config/redis/redis.conf:/etc/redis/redis.conf:ro
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - jumpserver_net
networks:
  jumpserver_net:
    name: jumpserver_net
    driver: bridge
